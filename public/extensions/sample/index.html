<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Extension Sample â€” Eventlog</title>
  <style>
    :root {
      --background: 0 0% 100%;
      --foreground: 240 10% 3.9%;
      --card: 0 0% 100%;
      --card-foreground: 240 10% 3.9%;
      --muted: 240 4.8% 95.9%;
      --muted-foreground: 240 3.8% 46.1%;
      --border: 240 5.9% 90%;
      --input: 240 5.9% 90%;
      --primary: 240 5.9% 10%;
      --primary-foreground: 0 0% 98%;
      --destructive: 0 84.2% 60.2%;
      --accent: 240 4.8% 95.9%;
      --ring: 240 5.9% 10%;
      --radius: 0.5rem;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      color: hsl(var(--foreground));
      background: hsl(var(--background));
      font-size: 0.875rem;
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
    }

    .container {
      padding: 1.5rem;
      max-width: 1200px;
      margin: 0 auto;
    }

    /* Badge / status pill */
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 0.375rem;
      padding: 0.125rem 0.625rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 500;
      line-height: 1.25rem;
      border: 1px solid hsl(var(--border));
      background: hsl(var(--background));
      color: hsl(var(--muted-foreground));
      transition: background 0.15s, color 0.15s, border-color 0.15s;
    }
    .badge .dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: currentColor;
    }
    .badge.connected {
      background: hsl(142 76% 96%);
      color: hsl(142 72% 29%);
      border-color: hsl(142 72% 29% / 0.2);
    }
    .badge.error {
      background: hsl(0 84% 96%);
      color: hsl(var(--destructive));
      border-color: hsl(var(--destructive) / 0.2);
    }

    /* Card wrapper for the table */
    .card {
      border: 1px solid hsl(var(--border));
      border-radius: var(--radius);
      background: hsl(var(--card));
      overflow: hidden;
    }
    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.75rem 1rem;
      border-bottom: 1px solid hsl(var(--border));
    }
    .card-header p {
      font-size: 0.8125rem;
      color: hsl(var(--muted-foreground));
    }

    /* Table */
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8125rem;
    }
    thead {
      background: hsl(var(--muted));
    }
    th {
      text-align: left;
      padding: 0.5rem 1rem;
      font-weight: 500;
      font-size: 0.75rem;
      color: hsl(var(--muted-foreground));
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    td {
      padding: 0.5rem 1rem;
      border-top: 1px solid hsl(var(--border));
      color: hsl(var(--foreground));
    }
    tbody tr {
      transition: background 0.1s;
    }
    tbody tr:hover {
      background: hsl(var(--muted));
    }

    .mono {
      font-family: ui-monospace, SFMono-Regular, "SF Mono", Menlo, Consolas, "Liberation Mono", monospace;
      font-size: 0.75rem;
    }
    .truncate {
      max-width: 12rem;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .muted {
      color: hsl(var(--muted-foreground));
    }

    /* Link style */
    .link {
      color: hsl(var(--primary));
      cursor: pointer;
      text-decoration: underline;
      text-underline-offset: 4px;
      text-decoration-color: hsl(var(--primary) / 0.3);
      transition: text-decoration-color 0.15s;
    }
    .link:hover {
      text-decoration-color: hsl(var(--primary));
    }

    /* Error alert */
    .alert-error {
      padding: 0.75rem 1rem;
      border-radius: var(--radius);
      border: 1px solid hsl(var(--destructive) / 0.2);
      background: hsl(0 84% 96%);
      color: hsl(var(--destructive));
      font-size: 0.8125rem;
    }

    /* Empty state */
    .empty {
      padding: 2rem;
      text-align: center;
      color: hsl(var(--muted-foreground));
      font-size: 0.8125rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <div id="status" class="badge"><span class="dot"></span><span id="status-text">Connecting...</span></div>
    <div id="content" style="margin-top: 1rem;"></div>
  </div>

  <script>
    (function () {
      let hostOrigin = null
      let accessToken = null
      let services = null
      let autoRefreshTimer = null
      let autoRefreshActive = false

      const editorByType = {
        'core/article': 'Editor',
        'core/planning-item': 'Planning'
      }

      // SVG icon data URIs
      const ICON_REFRESH = 'data:image/svg+xml,' + encodeURIComponent(
        '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">'
        + '<path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>'
        + '<path d="M3 3v5h5"/>'
        + '<path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/>'
        + '<path d="M16 16h5v5"/>'
        + '</svg>'
      )

      const ICON_AUTO_REFRESH = 'data:image/svg+xml,' + encodeURIComponent(
        '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">'
        + '<path d="M12 2a10 10 0 0 1 7.38 16.75"/>'
        + '<path d="M12 22a10 10 0 0 1-7.38-16.75"/>'
        + '<path d="M16 16h5v5"/>'
        + '<path d="M8 8H3V3"/>'
        + '<circle cx="12" cy="12" r="2"/>'
        + '</svg>'
      )

      const ICON_CLEAR = 'data:image/svg+xml,' + encodeURIComponent(
        '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">'
        + '<path d="M18 6 6 18"/>'
        + '<path d="m6 6 12 12"/>'
        + '</svg>'
      )

      const ICON_ELEPHANT = 'data:image/svg+xml,' + encodeURIComponent(
        '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round">'
        + '<path d="M17 4c2.5 0 4 1.5 4 4v4c0 3-2 6-5 7.5"/>'
        + '<path d="M7 4c-2.5 0-4 1.5-4 4v4c0 3 2 6 5 7.5"/>'
        + '<path d="M12 4c-3 0-5 2-5 5v3c0 2 1 3.5 2.5 4.5"/>'
        + '<path d="M12 4c3 0 5 2 5 5v3c0 2-1 3.5-2.5 4.5"/>'
        + '<path d="M8 19.5V22"/>'
        + '<path d="M16 19.5V22"/>'
        + '<path d="M10 16c0 1 .5 2 2 2s2-1 2-2"/>'
        + '<circle cx="9.5" cy="10" r="1"/>'
        + '<circle cx="14.5" cy="10" r="1"/>'
        + '</svg>'
      )

      function makeButtons() {
        const buttons = [
          { kind: 'button', name: 'refresh', title: 'Refresh', iconUrl: ICON_REFRESH },
          { kind: 'button', name: 'auto_refresh', title: 'Auto refresh (5s)', iconUrl: ICON_AUTO_REFRESH, active: autoRefreshActive },
          { kind: 'separator' },
          { kind: 'button', name: 'clear', title: 'Clear', iconUrl: ICON_CLEAR, disabled: true }
        ]

        for (let g = 1; g <= 5; g++) {
          buttons.push({ kind: 'separator' })
          for (let b = 1; b <= 3; b++) {
            buttons.push({
              kind: 'button',
              name: 'sample_' + g + '_' + b,
              title: 'Sample ' + g + '.' + b,
              iconUrl: ICON_ELEPHANT
            })
          }
        }

        return buttons
      }

      const statusEl = document.getElementById('status')
      const statusText = document.getElementById('status-text')
      const contentEl = document.getElementById('content')

      function setStatus(state, text) {
        statusEl.className = 'badge ' + state
        statusText.textContent = text
      }

      async function fetchEventlog() {
        if (!accessToken || !services) return

        setStatus('connected', 'Fetching eventlog...')

        try {
          const res = await fetch(services.repositoryUrl + '/twirp/elephant.repository.Documents/Eventlog', {
            method: 'POST',
            headers: {
              'authorization': 'Bearer ' + accessToken,
              'content-type': 'application/json'
            },
            body: JSON.stringify({ after: -10 })
          })

          if (!res.ok) {
            throw new Error('HTTP ' + res.status + ': ' + res.statusText)
          }

          const data = await res.json()
          renderTable(data.items || data)
          setStatus('connected', 'Connected')
        } catch (err) {
          setStatus('error', 'Fetch failed')
          contentEl.innerHTML = '<div class="alert-error">Error: ' + escapeHtml(err.message) + '</div>'
        }
      }

      function escapeHtml(str) {
        const el = document.createElement('span')
        el.textContent = str
        return el.innerHTML
      }

      function renderTable(items) {
        if (!items || items.length === 0) {
          contentEl.innerHTML = '<div class="card"><div class="empty">No events found.</div></div>'
          return
        }

        let html = '<div class="card">'
          + '<div class="card-header"><p>Showing ' + items.length + ' most recent events</p></div>'
          + '<table><thead><tr>'
          + '<th>ID</th><th>Event</th><th>UUID</th>'
          + '<th>Timestamp</th><th>Type</th><th>Updater</th>'
          + '</tr></thead><tbody>'

        for (const item of items) {
          const uuid = String(item.uuid ?? '')
          const docType = String(item.type ?? '')
          const viewName = editorByType[docType]

          const uuidCell = viewName
            ? '<span class="link" data-open-view="' + escapeHtml(viewName) + '" data-open-id="' + escapeHtml(uuid) + '">'
              + escapeHtml(uuid) + '</span>'
            : escapeHtml(uuid)

          html += '<tr>'
            + '<td class="mono muted">' + escapeHtml(String(item.id ?? '')) + '</td>'
            + '<td>' + escapeHtml(String(item.event ?? '')) + '</td>'
            + '<td class="mono truncate" title="' + escapeHtml(uuid) + '">' + uuidCell + '</td>'
            + '<td class="muted">' + escapeHtml(String(item.timestamp ?? '')) + '</td>'
            + '<td>' + escapeHtml(docType) + '</td>'
            + '<td class="muted">' + escapeHtml(String(item.updater_uri ?? '')) + '</td>'
            + '</tr>'
        }

        html += '</tbody></table></div>'
        contentEl.innerHTML = html

        postToHost({ type: 'set_title', payload: { title: 'Eventlog: ' + items.length + ' items' } })
      }

      // Button click handlers
      async function handleRefresh() {
        // Acknowledge with refresh disabled while loading
        const loading = makeButtons()
        loading[0].disabled = true
        postToHost({ type: 'button_click_ack', payload: { buttons: loading } })

        await fetchEventlog()

        // Re-enable refresh
        postToHost({ type: 'set_buttons', payload: { buttons: makeButtons() } })
      }

      function handleAutoRefresh() {
        autoRefreshActive = !autoRefreshActive

        // Acknowledge with updated active state
        postToHost({ type: 'button_click_ack', payload: { buttons: makeButtons() } })

        if (autoRefreshActive) {
          fetchEventlog()
          autoRefreshTimer = setInterval(function () {
            fetchEventlog()
          }, 5000)
        } else {
          clearInterval(autoRefreshTimer)
          autoRefreshTimer = null
        }
      }

      function handleClear() {
        // Button is disabled, but acknowledge anyway
        postToHost({ type: 'button_click_ack', payload: { buttons: makeButtons() } })
      }

      function postToHost(data) {
        if (hostOrigin) {
          window.parent.postMessage(data, hostOrigin)
        }
      }

      window.addEventListener('message', function (event) {
        const msg = event.data
        if (!msg || !msg.type) return

        // Capture the host origin from the first message we receive
        if (!hostOrigin) {
          hostOrigin = event.origin
        } else if (event.origin !== hostOrigin) {
          return
        }

        switch (msg.type) {
          case 'access_token':
            if (msg.payload) {
              accessToken = msg.payload.accessToken
              fetchEventlog()
            }
            break

          case 'services':
            if (msg.payload) {
              services = msg.payload
              fetchEventlog()
            }
            break

          case 'button_click': {
            const name = msg.payload && msg.payload.name
            if (name === 'refresh') handleRefresh()
            else if (name === 'auto_refresh') handleAutoRefresh()
            else if (name === 'clear') handleClear()
            else postToHost({ type: 'button_click_ack', payload: { buttons: makeButtons() } })
            break
          }
        }
      })

      // Handle clicks on elements with data-open-view attribute
      document.addEventListener('click', function (e) {
        const el = e.target.closest('[data-open-view]')
        if (el) {
          postToHost({
            type: 'open',
            payload: {
              name: el.dataset.openView,
              props: { id: el.dataset.openId },
              target: e.shiftKey ? 'last' : undefined
            }
          })
        }
      })

      // Signal to parent that we are ready (use '*' since we don't know the host origin yet)
      window.parent.postMessage({
        type: 'loaded',
        payload: { title: 'Eventlog', buttons: makeButtons() }
      }, '*')
      setStatus('', 'Waiting for parent...')
    })()
  </script>
</body>
</html>
