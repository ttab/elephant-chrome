var D=Object.defineProperty;var E=t=>{throw TypeError(t)};var W=(t,e,s)=>e in t?D(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s;var k=(t,e,s)=>W(t,typeof e!="symbol"?e+"":e,s),v=(t,e,s)=>e.has(t)||E("Cannot "+s);var a=(t,e,s)=>(v(t,e,"read from private field"),s?s.call(t):e.get(t)),g=(t,e,s)=>e.has(t)?E("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,s),p=(t,e,s,c)=>(v(t,e,"write to private field"),c?c.call(t,s):e.set(t,s),s),n=(t,e,s)=>(v(t,e,"access private method"),s);var b={version:12};var i,o,h,u,r,x,I,l,C,M,m,S,d=class d{constructor(){g(this,r);g(this,i,[]);g(this,o);g(this,h);g(this,u)}static getInstance(){return d.instance||(d.instance=new d),d.instance}addClient(e){a(this,i).push(e),e.onmessage=s=>{switch(s.data.type){case"upgrade":n(this,r,I).call(this,s.data);break;case"connect":n(this,r,x).call(this,s.data)?n(this,r,M).call(this,{type:"connected",payload:{version:b.version}}):n(this,r,S).call(this,e,"disconnected");break;case"disconnect":n(this,r,l).call(this),n(this,r,S).call(this,e,"disconnected");break}},e.start(),n(this,r,S).call(this,e,a(this,o)?"connected":"disconnected")}};i=new WeakMap,o=new WeakMap,h=new WeakMap,u=new WeakMap,r=new WeakSet,x=function(e){let{url:s,accessToken:c}=e.payload;if(a(this,o)&&c!==a(this,u)&&n(this,r,l).call(this),!a(this,o)&&!c)return n(this,r,m).call(this,"No access token received"),!1;let f=new URL(s);return f.searchParams.set("topic","firehose"),f.searchParams.set("token",c),p(this,h,f),p(this,u,c),n(this,r,C).call(this)},I=function(e){n(this,r,l).call(this),n(this,r,M).call(this,{type:"upgrade",payload:{version:e.payload.version}},!0),a(this,i).forEach(s=>{s.close()}),a(this,i).length=0,self.close()},l=function(){a(this,o)&&(a(this,o).close(),p(this,o,void 0))},C=function(){return a(this,h)?(p(this,o,new EventSource(a(this,h).toString())),a(this,o).onmessage=e=>{n(this,r,M).call(this,{type:"sse",payload:JSON.parse(e.data)})},a(this,o).onerror=e=>{n(this,r,m).call(this,"Eventsource error caught, "+e.type)},!0):!1},M=function(e,s=!1){a(this,i).forEach(c=>{c.postMessage(e)}),s&&a(this,i).forEach(c=>{s&&c.close()})},m=function(e){a(this,i).forEach(s=>{s.postMessage({type:"debug",payload:{message:e,clients:a(this,i).length}})})},S=function(e,s){e.postMessage({type:s,payload:{version:b.version}})},k(d,"instance");var y=d;self.onconnect=t=>{y.getInstance().addClient(t.ports[0])};
