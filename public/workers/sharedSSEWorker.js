var U=Object.defineProperty;var m=n=>{throw TypeError(n)};var w=(n,e,s)=>e in n?U(n,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):n[e]=s;var E=(n,e,s)=>w(n,typeof e!="symbol"?e+"":e,s),b=(n,e,s)=>e.has(n)||m("Cannot "+s);var a=(n,e,s)=>(b(n,e,"read from private field"),s?s.call(n):e.get(n)),h=(n,e,s)=>e.has(n)?m("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(n):e.set(n,s),d=(n,e,s,c)=>(b(n,e,"write to private field"),c?c.call(n,s):e.set(n,s),s),r=(n,e,s)=>(b(n,e,"access private method"),s);var u,i,o,g,M,t,T,I,C,l,S,k,y,x,p=class p{constructor(){h(this,t);h(this,u,0);h(this,i,[]);h(this,o);h(this,g);h(this,M)}static getInstance(){return p.instance||(p.instance=new p),p.instance}addClient(e){a(this,i).push(e),e.onmessage=s=>{switch(s.data.type){case"upgrade":r(this,t,C).call(this,s.data);break;case"connect":r(this,t,T).call(this,s.data),r(this,t,k).call(this,{type:"connected",payload:{version:a(this,u)}});break;case"accessToken":r(this,t,I).call(this,s.data);break}},e.start(),r(this,t,x).call(this,e,a(this,o)?"connected":"notconnected")}};u=new WeakMap,i=new WeakMap,o=new WeakMap,g=new WeakMap,M=new WeakMap,t=new WeakSet,T=function(e){if(a(this,o))return;let{url:s,accessToken:c,version:P}=e.payload,f=new URL(s);f.searchParams.set("topic","firehose"),f.searchParams.set("token",c),d(this,g,f),d(this,u,P),d(this,M,c),r(this,t,S).call(this)},I=function(e){let s=e.payload.accessToken;!s||s===a(this,M)||!a(this,g)||(r(this,t,l).call(this),d(this,M,s),a(this,g).searchParams.set("token",s),r(this,t,S).call(this))},C=function(e){r(this,t,l).call(this),r(this,t,k).call(this,{type:"upgrade",payload:{version:e.payload.version}},!0),self.close(),a(this,i).length=0},l=function(){a(this,o)&&(a(this,o).close(),d(this,o,void 0),r(this,t,y).call(this,"Disconnected from event source"))},S=function(){a(this,g)&&(d(this,o,new EventSource(a(this,g).toString())),r(this,t,y).call(this,"Connected to event source"),a(this,o).onmessage=e=>{r(this,t,k).call(this,{type:"sse",payload:JSON.parse(e.data)})},a(this,o).onerror=e=>{r(this,t,y).call(this,"Eventsource error caught"),r(this,t,l).call(this),r(this,t,S).call(this)})},k=function(e,s=!1){console.log(e),a(this,i).forEach(c=>{c.postMessage(e)}),s&&a(this,i).forEach(c=>{s&&c.close()})},y=function(e){a(this,i).forEach(s=>{s.postMessage({type:"debug",payload:{message:e,clients:a(this,i).length}})})},x=function(e,s){e.postMessage({type:s,payload:{version:a(this,u)}})},E(p,"instance");var v=p;self.onconnect=n=>{v.getInstance().addClient(n.ports[0])};
